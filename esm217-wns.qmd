---
title: "White-Nose Syndrome and Pesticides"
subtitle: "Investigating the connection between White-nose syndrome in bats and increases in pesticide use in agriculture."
author: "Madi Calbert & Steven Mitchell"
date: last-modified
execute: 
  eval: false
  echo: true
  warning: false
  message: false
format:
  html:
    toc: true
    code-fold: true
    theme: lux
editor_options: 
  chunk_output_type: console
---
![A bat suffering from White-nose syndrome, a disease caused by the fungus *Pseudomycans destructans* (commonly abbreviated as "Pd"). *Photo credit: Google Creative Commons*](bat-wns.jpeg)

# Proposal

We will investigate the impacts to crop production from an infectious fungal disease affecting bats.The fungus *Pseudogymnoascus destructans* causes white-nose syndrome in hibernating bats and has spread across the United States. Declining bat populations are expected to have substantial impacts on the environment, specifically agriculture. Bats eat insects that damage crops and the consumption of these insects by bats saves farmers billions of dollars in pest control services annually. We will map white-nose syndrome occurrence and pesticide use by county across the US. The white-nose syndrome data from USGS  is a time series of categorical presence/absence data. The pesticide use data is a time series of continuous concentration data. We will run a linear regression to quantify the relationship between white-nose syndrome detection and pesticide use. Time allowing, we will take it a step further by incorporating public health data and run a linear regression between pesticide use and negative health outcomes.


# Data Exploration

## Setup

### Libraries

```{r}
library(here)
library(tidyverse)
library(sf)
library(tmap)
library(viridisLite)
library(biscale)

```

### Global Map Options

```{r}
# US state boundary data for use as a bounding box
us <- read_sf(here("data", "tl_2024_state", "tl_2024_us_state.shp")) %>% 
  filter(!STUSPS %in% c("MP", "GU", "AS", "AK", "HI", "PR", "VI"))

# make a bounding box
bbox <- st_bbox(us)

# load US counties shapefile
counties <- read_sf(here("data", "tl_2023_us_county", "tl_2023_us_county.shp")) %>% 
  mutate(county = NAME)

# Define  color palettes
wns_palette <- c("white", "blue")
pesticide_palette <- c("white", "red")  
```

## *Pseudomycan destructans* and White-Nose Syndrome Detections by County


```{r}



# load WNS status by county data
wns <- read_sf(here("data", "wns_county_status", "wns_county_status.csv"))

# join them
wns_counties <- left_join(counties, wns, by = "county") %>% 
  mutate(determination = factor(determination, levels = c("Pd Presumed", "WNS Suspect", "Pd Positive", "WNS Positive"), ordered = TRUE))

# Exploratory WNS-by-County Map
map_wns_counties <- tm_shape(wns_counties, bbox = bbox)+
  tm_polygons(col = "determination",
              palette = wns_palette,
              NA.col = "white",
              title = "Pd / WNS Status")+
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_layout(title = "White-Nose Syndrome Occurrence by County",
            title.position = c("left", "bottom"),
            legend.position = c("right", "bottom"))

# tmap_save(map_wns_counties, here("outputs", "map_wns_counties.png"))
```

![](outputs/map_wns_counties.png)

## Pesticide Use by County

```{r}
pesticides <- read_csv(here("data", "2013_2017_pesticides", "EPest_county_estimates_2013_2017_v2.csv")) %>% 
  mutate(COUNTYFP = as.character(COUNTY_FIPS_CODE)) %>% 
  mutate(concentration = ifelse(is.na(EPEST_HIGH_KG), 
                                EPEST_LOW_KG, EPEST_HIGH_KG)) %>% 
  group_by(COUNTYFP, YEAR) %>% 
  summarise(total_pesticides_kg = sum(concentration, na.rm = TRUE))

# join them
pesticides_counties <- left_join(counties, pesticides, by = "COUNTYFP") 

map_pesticides_counties <- tm_shape(pesticides_counties, bbox = bbox)+
  tm_polygons(col = "total_pesticides_kg",
              palette = pesticide_palette,
              breaks = quantile(pesticides_counties$total_pesticides_kg,
                                probs = seq(0, 1, by = 0.10), na.rm = TRUE),
              title = "Total Pesticide Use (Kg)",
              NA.col = "white",
              labels = c("0 - 62 K", "62 - 518 K", "518 K - 1.3 mil", "1.3 - 1.7 mil", 
                         "1.7 - 2 mil", "2 - 2.2 mil", "2.2 - 2.4 mil", 
                         "2.4 - 2.6 mil", "2.6 - 3.1 mil","3.1 - 5.9 mil"))+
  tm_compass(position = c("left", "bottom"))+
  tm_scale_bar(position = c("left", "bottom"))+
  tm_layout(title = "Pesticide Use by County",
            title.position = c("left", "bottom"),
            legend.position = c("right", "bottom"))

# tmap_save(map_pesticides_counties, here("outputs", "map_pesticides_counties.png"))
```

![](outputs/map_pesticides_counties.png)

##  WNS Status & Pesticide Use by County

```{r}
wns_pesticides <- left_join(wns_counties, pesticides, by = "COUNTYFP") %>% 
  drop_na(determination, total_pesticides_kg)

wns_pesticides_bivariate <- bi_class(wns_pesticides,
                 x = "determination", 
                 y = "total_pesticides_kg", 
                 style = "quantile", dim = 4)

bi_pallet <- c("Blue", "Pink")
```


```{r}
ggplot()+
  theme_void(base_size = 14)+
  geom_sf(data = wns_pesticides_bivariate, aes(fill = bi_class), 
          color = NA , show.legend = FALSE)+
  bi_scale_fill(aes(pal = "DkBlue2", dim = 4, flip_axes = FALSE, rotate_pal = FALSE))+
  geom_sf(counties, aes(fill = NA), color = "black", linewidth = 0.20)


map_wns_pesticides <- tm_shape(counties, bbox = bbox)+
  tm_polygons(col = "white")+
  tm_shape(wns_pesticides_bivariate)+
  tm_polygons(tm_vars(c("determination", "total_pesticides_kg"), 
                      multivariate = TRUE),
              fill.scale = tm_scale("DkBlue2"))

tm_shape(wns_pesticides_bivariate, bbox = bbox)+
  tm_polygons(bi_class, fill.scale = tm_scale("DkBlue2"))

tmap_save(map_wns_pesticides, here("outputs", "map_wns_pesticides.png"))

```

```{r}

# Chat GPT doesnt work
tm_shape(counties, bbox = bbox) +
  tm_polygons(col = "white") +  # Base layer with white fill for counties
  tm_shape(wns_pesticides_bivariate) +
  tm_polygons(
    aes(fill = bi_class),  # Map the bivariate classification to fill color
    palette = bi_pallet,    # Set the custom palette
    fill = "bi_class",      # Define the variable for fill as bi_class
    fill.scale = tm_scale("quantile")  # Apply quantile scale for color breaks
  ) +
  tm_layout(legend.position = c("left", "bottom"))

```


![](outputs/map_wns_pesticides.png)
